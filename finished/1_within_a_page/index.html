<body>
  <video id="local" autoplay muted></video>
  <video id="remote" autoplay></video>
  <button onclick="start(this)">start video</button>
  <button id="stream" onclick="stream(this)" disabled>stream video</button>

  <script>
    // get video elements
    const local = document.querySelector("video#local");
    const remote = document.querySelector("video#remote");

    // function to ask for camera and microphone permission
    // and stream to #local video element
    function start(e) {
      e.disabled = true;
      navigator.mediaDevices.getUserMedia({ audio: true, video: true })
        .then((stream) => {
          local.srcObject = stream;
          document.getElementById("stream").disabled = false;  // enable the stream button
        })
        .catch(() => e.disabled = false);
    }

    function stream(e) {
      // disable the stream button
      e.disabled = true;
      
      const localPeer = new RTCPeerConnection();  // local peer
      const remotePeer = new RTCPeerConnection();  // remote peer

      // if an icecandidate event is triggered in a peer add the ice candidate to the other peer
      localPeer.addEventListener("icecandidate", e => { console.log("Local:", e.candidate); remotePeer.addIceCandidate(e.candidate) });
      remotePeer.addEventListener("icecandidate", e => { console.log("Remote:", e.candidate); localPeer.addIceCandidate(e.candidate) });

      // if the remote peer detects a track in the connection, it forwards it to the remote video element
      remotePeer.addEventListener("track", e => remote.srcObject = e.streams[0]);

      // get camera and microphone source tracks and add it to the local peer
      local.srcObject.getTracks()
        .forEach(track => localPeer.addTrack(track, local.srcObject));
      
      // Start the handshake process
      localPeer.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true })
        .then(async offer => {
          await localPeer.setLocalDescription(offer);
          await remotePeer.setRemoteDescription(offer);
          console.log("Created offer");
        })
        .then(() => remotePeer.createAnswer())
        .then(async answer => {
          await remotePeer.setLocalDescription(answer);
          await localPeer.setRemoteDescription(answer);
          console.log("Created answer");
        });
    }
  </script>
</body>
